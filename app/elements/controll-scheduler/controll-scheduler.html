<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id="controll-scheduler">
<template>
	<style>
	:host {
		display: block;
		box-sizing: border-box;
	}
	.flex-horizontal { 
		@apply (--layout-horizontal);
	}
	
	.flexchild { 
		@apply (--layout-flex);
	}
	paper-item div, paper-item paper-item-body {
		margin: 0 1em;
	}
	.flex-horizontal { 
		@apply (--layout-horizontal);
	}
	
	.flexchild { 
		@apply (--layout-flex);
	}
	paper-material {
		margin: .3em;
		background: white;
	}
	
	paper-material.card {
		padding: .5em;
	}
	</style>

	<template is="dom-repeat" items="[[locations]]" as="location">
		<paper-material elevation="1" class="card">
			<h3>[[location.title]]</h3>
			<template is="dom-repeat" items="[[location.timeslots]]" as="timeslot">
				<paper-material elevation="1">
					<paper-item  class="container flex-horizontal">
						<paper-icon-button icon="input"  on-tap="gotoEvent"></paper-icon-button>
						<paper-item-body>[[timeslot.event.title]]</paper-item-body>
						<paper-item-body>[[timeslot.displayTime]]</paper-item-body>
						<paper-item-body class="flexchild">
							<strong>Hosts:</strong>
							<template is="dom-repeat" items="[[timeslot.hosts]]" as="host">
								[[host.name]]
							</template>
						</paper-item-body>
					</paper-item>
				</paper-material>
			</template>
		</paper-material>
	</template>
</template>
</dom-module>

<Script>
Polymer({
	is: 'controll-scheduler',
	Properties: {
		conventionProperties: Object,
		events: Array,
		locations: Array,
		timeslots: Array
	},
	
	attached : function() {
		// handle reload command
		app.addEventListener('please-refresh-lists', this.ready.bind(this), false);
	},
	
	ready : function() {
		this.needData = 4;
		// load stuff that we need for the scheduler
		ConTroll.conventions.getCurrent((function(con){
			this.conventionProperties = con;
			this.needData -= 1;
		}).bind(this));
		app.getCatalog('locations',(function(locations){
			this.locations = locations.map(function(location){
				location.timeslots = location.timeslots.map(function(timeslot){
					timeslot.displayTime = moment(timeslot.start).format("MMM D, YYYY HH:mm");
					return timeslot;
				});
				return location;
			});
			this.needData -= 1;
		}).bind(this));
		app.getCatalog('events',(function(events){
			this.events = events;
			this.needData -= 1;
		}).bind(this));
		app.getCatalog('timeslots',(function(timeslots){
			this.timeslots = timeslots.map(function(timeslot){
				timeslot.displayTime = moment(timeslot.start).format("MMM D, YYYY HH:mm");
				return timeslot;
			});
			this.needData -= 1;
		}).bind(this));
		this.waitingToBeReady = window.setInterval(this.waitForDataReady.bind(this),100);
	},
	
	waitForDataReady : function() {
		if (this.needData != 0)
			return;
		window.clearInterval(this.waitingToBeReady);
		delete this.waitingToBeReady;
	},
	
	gotoEvent : function(event) {
		page.show('/events/' + event.model.timeslot.event.id);
	}
});
</Script>
